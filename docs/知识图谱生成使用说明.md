# 知识图谱生成功能使用说明

## 功能概述

智能知识图谱生成功能能够根据数据库中已有的课程、章节、小节信息，通过Dify智能体自动生成可视化的知识图谱，帮助教师和学生更好地理解课程知识结构。

## 工作流程

### 1. 数据获取阶段
系统从数据库中提取：
- **课程基本信息**: 课程名称、描述、类型、学分等
- **章节信息**: 章节标题、描述、排序等
- **小节信息**: 小节标题、描述、视频时长等

### 2. 数据结构化阶段
将提取的数据组织成JSON格式：
```json
{
  "course": {
    "id": 5,
    "title": "Java编程基础",
    "description": "Java语言基础知识和编程技能",
    "courseType": "必修课",
    "credit": 3.0
  },
  "chapters": [
    {
      "id": 11,
      "title": "Java基础语法",
      "description": "变量、数据类型、运算符等",
      "sortOrder": 1,
      "sections": [
        {
          "id": 21,
          "title": "变量和数据类型",
          "description": "Java中的基本数据类型",
          "duration": 1800,
          "sortOrder": 1
        }
      ]
    }
  ]
}
```

### 3. 智能体生成阶段
Dify智能体根据结构化数据和生成参数：
- 分析课程内容和知识结构
- 识别知识点和概念关系
- 生成符合要求的知识图谱JSON数据

### 4. 数据存储阶段
生成的知识图谱保存到数据库，包含：
- 图谱基本信息（标题、描述、类型等）
- 完整的图谱数据（节点、边、样式等）
- 权限和共享设置

## API使用示例

### 教师端生成知识图谱

```http
POST /api/teacher/knowledge-graph/generate
Content-Type: application/json
Authorization: Bearer {teacher_token}

{
  "courseId": 5,
  "chapterIds": [11, 12, 13],
  "graphType": "comprehensive",
  "depth": 3,
  "includePrerequisites": true,
  "includeApplications": true,
  "additionalRequirements": "重点突出编程实践技能"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "status": "completed",
    "taskId": "kg_20241228_001",
    "graphData": {
      "id": 1,
      "title": "Java编程基础知识图谱",
      "description": "包含Java基础语法、面向对象等核心概念",
      "nodes": [
        {
          "id": "node_1",
          "name": "Java基础语法",
          "type": "chapter",
          "level": 1,
          "description": "Java语言的基础语法知识",
          "chapterId": 11,
          "style": {
            "color": "#f39c12",
            "size": 30,
            "shape": "circle",
            "fontSize": 16
          },
          "position": {
            "x": 400,
            "y": 200,
            "fixed": false
          }
        },
        {
          "id": "node_2", 
          "name": "变量和数据类型",
          "type": "concept",
          "level": 2,
          "description": "Java中的变量声明和基本数据类型",
          "chapterId": 11,
          "sectionId": 21,
          "style": {
            "color": "#3498db",
            "size": 25,
            "shape": "circle",
            "fontSize": 14
          },
          "position": {
            "x": 300,
            "y": 350,
            "fixed": false
          }
        }
      ],
      "edges": [
        {
          "id": "edge_1",
          "source": "node_1",
          "target": "node_2",
          "type": "contains",
          "description": "包含",
          "weight": 1.0,
          "style": {
            "color": "#7f8c8d",
            "width": 2,
            "lineType": "solid",
            "showArrow": true
          }
        }
      ],
      "metadata": {
        "nodeCount": 2,
        "edgeCount": 1,
        "generatedAt": "2024-12-28T10:30:00",
        "aiGenerated": true,
        "source": "dify_agent"
      }
    },
    "suggestions": "建议添加更多编程实例来说明概念"
  }
}
```

### 学生端查看知识图谱

```http
GET /api/student/knowledge-graph/{graphId}
Authorization: Bearer {student_token}
```

## 前端集成示例

### Vue组件使用

```vue
<template>
  <div class="knowledge-graph-container">
    <!-- 生成控制面板 -->
    <div class="control-panel" v-if="isTeacher">
      <el-form @submit.prevent="generateGraph">
        <el-form-item label="图谱类型">
          <el-select v-model="generateForm.graphType">
            <el-option label="综合图谱" value="comprehensive" />
            <el-option label="概念图谱" value="concept" />
            <el-option label="技能图谱" value="skill" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="深度级别">
          <el-slider v-model="generateForm.depth" :min="1" :max="5" />
        </el-form-item>
        
        <el-button type="primary" @click="generateGraph" :loading="generating">
          {{ generating ? '生成中...' : 'AI生成知识图谱' }}
        </el-button>
      </el-form>
    </div>

    <!-- 知识图谱显示 -->
    <KnowledgeGraph 
      :graph-data="graphData"
      :editable="isTeacher"
      @node-click="handleNodeClick"
      @save="handleSave"
    />
  </div>
</template>

<script>
import { generateKnowledgeGraph } from '@/api/knowledgeGraph'
import KnowledgeGraph from '@/components/KnowledgeGraph.vue'

export default {
  components: {
    KnowledgeGraph
  },
  data() {
    return {
      generating: false,
      graphData: null,
      generateForm: {
        courseId: this.$route.params.courseId,
        chapterIds: [],
        graphType: 'comprehensive',
        depth: 3,
        includePrerequisites: true,
        includeApplications: true
      }
    }
  },
  methods: {
    async generateGraph() {
      try {
        this.generating = true
        const response = await generateKnowledgeGraph(this.generateForm)
        
        if (response.data.status === 'completed') {
          this.graphData = response.data.graphData
          this.$message.success('知识图谱生成成功！')
        } else {
          this.$message.warning('知识图谱生成中，请稍后查看')
        }
      } catch (error) {
        this.$message.error('生成失败：' + error.message)
      } finally {
        this.generating = false
      }
    },
    
    handleNodeClick(node) {
      // 处理节点点击事件
      if (node.sectionId) {
        // 跳转到对应小节
        this.$router.push(`/section/${node.sectionId}`)
      }
    },
    
    async handleSave(graphData) {
      // 保存图谱修改
      try {
        await this.updateKnowledgeGraph(graphData.id, graphData)
        this.$message.success('保存成功')
      } catch (error) {
        this.$message.error('保存失败：' + error.message)
      }
    }
  }
}
</script>
```

## 生成参数说明

### 必填参数
- **courseId**: 课程ID，指定要生成知识图谱的课程
- **chapterIds**: 章节ID数组，指定包含哪些章节

### 可选参数
- **graphType**: 图谱类型
  - `comprehensive`: 综合图谱（默认）- 包含概念、技能、应用等
  - `concept`: 概念图谱 - 重点展示概念关系
  - `skill`: 技能图谱 - 重点展示技能递进关系

- **depth**: 深度级别（1-5，默认3）
  - 1-2: 简洁版，主要核心概念
  - 3: 标准版，平衡详细度和清晰度
  - 4-5: 详细版，包含更多细节和关系

- **includePrerequisites**: 是否包含先修关系（默认true）
- **includeApplications**: 是否包含应用关系（默认true）
- **additionalRequirements**: 额外要求，文本描述

## 最佳实践

### 1. 数据准备
- 确保课程、章节、小节信息完整且描述详细
- 章节和小节的描述应该包含关键概念和知识点
- 保持数据的逻辑结构清晰

### 2. 参数选择
- **初次生成**: 建议使用 `comprehensive` 类型 + `depth=3`
- **概念梳理**: 使用 `concept` 类型 + `depth=2-3`
- **技能训练**: 使用 `skill` 类型 + `depth=3-4`
- **复杂课程**: 可以分章节生成，然后合并

### 3. 结果优化
- 生成后可以手动调整节点位置和样式
- 添加自定义的节点和关系
- 根据教学需要调整图谱的重点展示内容

### 4. 教学应用
- **教师**: 用于课程设计、知识点梳理、教学路径规划
- **学生**: 用于预习复习、知识点查缺补漏、学习路径指导

## 故障排除

### 常见问题

1. **生成失败 - "课程不存在"**
   - 检查courseId是否正确
   - 确认用户有访问该课程的权限

2. **生成失败 - "未找到有效的章节信息"**
   - 检查chapterIds是否正确
   - 确认章节属于指定的课程

3. **生成结果不理想**
   - 尝试调整depth参数
   - 在additionalRequirements中添加具体要求
   - 检查章节描述是否足够详细

4. **Dify智能体响应错误**
   - 检查Dify工作流配置
   - 确认API密钥和端点配置正确
   - 查看后端日志获取详细错误信息

### 日志查看

在 `logs/education-platform.log` 中查看详细的生成过程日志：
```
2024-12-28 10:30:00 INFO  - 开始生成知识图谱，课程ID: 5, 章节数: 3
2024-12-28 10:30:01 INFO  - 已构建结构化课程数据，包含3个章节，共8个小节
2024-12-28 10:30:02 INFO  - 调用Dify智能体生成知识图谱，参数配置完成
2024-12-28 10:30:05 INFO  - Dify智能体生成完成，开始解析结果
2024-12-28 10:30:06 INFO  - 知识图谱解析成功: 12 个节点, 15 条边
2024-12-28 10:30:07 INFO  - 知识图谱生成并保存成功，图谱ID: 1
```

通过以上流程，您可以轻松地为任何课程生成智能化的知识图谱，提升教学效果和学习体验。 